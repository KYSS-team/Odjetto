# Telegram-бот для корпоративных обедов

Бот реализует выдачу одноразовых токенов для сотрудников, оформление заказов из подключенных ресторанов и автоматическую отправку отчётов менеджеру.

## Возможности
- Авторизация по Telegram ID и одноразовым паролям, выданным менеджером.
- Управление сотрудниками и лимитом дневных средств менеджером.
- Загрузка ресторанов и меню, выбор офиса с автоподстановкой ранее созданных значений.
- Заказ обедов на текущую неделю с учётом дедлайна 12:00 и лимита дневных средств (по умолчанию 400 ₽).
- Пополнение баланса при превышении лимита, уведомления о возврате лишних пополнений при изменении заказа.
- Запрет повторного заказа на выбранную дату, возможность изменять заказ до 12:00 дня выдачи.
- Ежедневная отправка XLS-отчётов по ресторанам в указанное время.

## Стек
- [Aiogram](https://docs.aiogram.dev/) для работы с Telegram Bot API.
- [SQLAlchemy](https://www.sqlalchemy.org/) и SQLite для хранения пользователей, меню и заказов.
- [APScheduler](https://apscheduler.readthedocs.io/) для плановой отправки отчётов.
- [pandas](https://pandas.pydata.org/) для генерации XLS-файлов.

## Настройка и запуск
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Создайте файл `.env` (можно скопировать из `.env.example`) и укажите значения:
   - `BOT_TOKEN` — токен Telegram-бота (обязателен).
   - `ADMIN_PASSWORD` — пароль менеджера (по умолчанию `admin`).
   - `REPORT_HOUR` и `REPORT_MINUTE` — время отправки отчётов.
   - `DB_NAME`, `DEFAULT_LIMIT` и `ORDER_DEADLINE_HOUR` при необходимости.
3. Запустите бота:
   ```bash
   docker-compose up -d
   ```
   или
   ```bash
   pip install -r requirements.txt
   python main.py
   ```
   При первом запуске автоматически создаётся база данных и устанавливается базовый дневной лимит.
4. Просмотр логов:
   ```bash
   docker-compose logs -f
   ```

## Основные файлы
- `main.py` — точка входа: инициализация БД, запуск диспетчера и планировщика отчётов.
- `handlers_auth.py` — авторизация и выбор интерфейса сотрудника/менеджера.
- `handlers_manager.py` — управление сотрудниками, меню и лимитом.
- `handlers_orders.py` — оформление и редактирование заказов сотрудниками.
- `reports.py` — генерация и отправка ежедневных XLS-отчётов по ресторанам.
- `states.py` — определения FSM-состояний для диалогов.

## Первые шаги
1. Менеджер входит по `ADMIN_PASSWORD` и попадает в панель.
2. Создайте сотрудников через кнопку «Управление сотрудниками» — бот выдаст одноразовый код приглашения.
3. Добавьте рестораны и блюда через «Меню/рестораны».
4. Сотрудники активируют бот по выданному коду, выбирают дату/ресторан и оформляют заказ.
5. В установленное время менеджер получает XLS-отчёты по каждому ресторану.

Ссылка на бота: https://t.me/odjetto_lunch_bot
